name: Generate Keystore

on:
  workflow_dispatch:

jobs:
  generate-keystore:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Keystore
        run: |
          # Generate variables
          ALIAS="varisankya-alias"
          # Use hex to ensure alphanumeric passwords (no special chars)
          PASSWORD=$(openssl rand -hex 12)
          KEY_PASSWORD=$(openssl rand -hex 12)
          
          # Generate Keystore
          keytool -genkey -v -keystore release.keystore \
            -alias $ALIAS \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass $PASSWORD \
            -keypass $KEY_PASSWORD \
            -dname "CN=Varisankya, OU=App, O=Varisankya, L=Unknown, ST=Unknown, C=US"

          # Encode to Base64 directly to file to avoid shell variable limits/truncation
          base64 -w 0 release.keystore > keystore_base64.txt

          # Output Secrets to Console (for reference - might be truncated)
          # We read from file to ensure we display what we saved
          BASE64_KEYSTORE=$(cat keystore_base64.txt)
          echo "::notice title=ANDROID_KEYSTORE_BASE64::$BASE64_KEYSTORE"
          echo "::notice title=KEYSTORE_PASSWORD::$PASSWORD"
          echo "::notice title=KEY_ALIAS::$ALIAS"
          echo "::notice title=KEY_PASSWORD::$KEY_PASSWORD"
          
          # Save secrets to files for artifact upload
          # Use printf to avoid trailing newlines
          printf "%s" "$PASSWORD" > keystore_password.txt
          printf "%s" "$ALIAS" > key_alias.txt
          printf "%s" "$KEY_PASSWORD" > key_password.txt
          
          echo "========================================================"
          echo "SECRETS ARE ALSO UPLOADED AS AN ARTIFACT FOR SAFETY"
          echo "========================================================"

      - name: Upload Secrets Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-signing-secrets
          path: |
            keystore_base64.txt
            keystore_password.txt
            key_alias.txt
            key_password.txt
          retention-days: 1
